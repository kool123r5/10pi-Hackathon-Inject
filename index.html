<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.3/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>

    <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyBaDphTXbRG6XTg-u2LBIhp04plQ7Ipsg0",
        authDomain: "pi-hackathon.firebaseapp.com",
        projectId: "pi-hackathon",
        storageBucket: "pi-hackathon.appspot.com",
        messagingSenderId: "747594716195",
        appId: "1:747594716195:web:e4eed3c1a15b9457864d96"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    </script>

<link
href="https://fonts.googleapis.com/css?family=Poppins&display=swap"
rel="stylesheet"
/>
<link
rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
crossorigin="anonymous"
/>

    <style>

body{
   background-color: #1e1e1e;
    color: white;
    font-family: "Poppins", sans-serif;
    min-height: 100vh;
}

.signInAuths{
    display: flex;
    align-items: center;
    justify-content: center;
    height: 350px;
    width: 500px;
    position: relative;
    right: -535px;
    top: 100px;
    border-radius: 10px;
}

#twitterSignInBtn{
    border-radius: 10px;
    width: 400px;
    height: 100px;
    background-color: #18191c;
    color: white;
    font-size: 30px;
    text-align: center;
    border: none;
    position: relative;
    right: -45px;
}

#twitterSignInBtn:hover{
    background-color: #1DA1F2;
    cursor: pointer;
    color: #1e1e1e;
}

#twitterIcon{
    padding: 15px;
    position: relative;
    font-size: 50px;
}


#signInBtn{
    border-radius: 10px;
    width: 400px;
    height: 100px;
    background-color: #18191c;
    color: white;
    font-size: 30px;
    text-align: center;
    border: none;
    position: relative;
    right: -45px;
    margin-bottom: 5px;
}

#signInBtn:hover{
    background-color: #DB4437;
    cursor: pointer;
    color: #1e1e1e;
}

#googleIcon{
    padding: 15px;
    position: relative;
    font-size: 50px;
}

#githubSignInBtn{
    border-radius: 10px;
    width: 400px;
    height: 100px;
    background-color: #18191c;
    color: white;
    font-size: 30px;
    text-align: center;
    border: none;
    position: relative;
    right: -45px;
    margin-top: 5px;
}

#githubSignInBtn:hover{
    background-color: #6cc644;
    cursor: pointer;
    color: #1e1e1e;
}

#githubIcon{
    padding: 15px;
    position: relative;
    font-size: 50px;
}

.welcomeSign{
    text-align: center;
    color: #c6d8f5;
    font-size: 50px;
}

#errors{
    color: white;
    text-align: center;
}
#socialButton{
  cursor: pointer;
}

#todoListButtonShowing{
  cursor: pointer;
}
  
#showCounsellors{
  cursor: pointer;
}

#counsellors{
  position: relative;
  top: -500px;
}



    </style>
</head>
<body>

<div class="signInAuths">

<section id="whenSignedOut">

    <h1 class="welcomeSign">Welcome!</h1>

    <button id="signInBtn"><i id="googleIcon" class="fab fa-google"></i>Google Sign-in</button>

    <button id="twitterSignInBtn" onclick = "twitterSignin()"><i id="twitterIcon" class="fab fa-twitter"></i>Twitter Sign-in</button>

    <button id="githubSignInBtn" onclick = "githubSignin()"><i id="githubIcon" class="fab fa-github"></i>Github Sign-in</button>

    <div id="errors"></div>


</section>
</div>

<section id="whenSignedIn" hidden="true">

  <!-- <div class="navbar">
    <header>
      <img class="logo" src="/images/unknown.png" alt="logo">
      <nav>
          <ul class="nav_links">
              <li><a href="#">Schedular</a></li>
              <li><a href="#">tutors</a></li>
              <li><a href="#">Clubs</a></li>
              <li><a href="#">Calenders</a></li>
              <li><a href="#">Campus</a></li>
          </ul>
      </nav>
      <a class="cta" href="#"><button>Login</button></a>
  </header>
</div> -->

    <button id="signOutBtn">Sign out!</button>

      <div class="social" id="social" hidden='true'>
      </div>

    <div id="linking">
      <a id="scheduleLink" href="schedule.html">Schedule!</a>
      <a href="todo.html">Todo!</a>
      <button id="socialButton">Click to show social!</button>
    </div>
  </div>
</section>

</body>
<script defer>
const auth = firebase.auth();

const whenSignedIn = document.getElementById('whenSignedIn');
const whenSignedOut = document.getElementById('whenSignedOut');

const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const errorDiv = document.getElementById('errors');
const divContainerThing = document.getElementById('todo-container');

const socialDiv = document.getElementById('social');
const socialButton = document.getElementById('socialButton');
const todoButtonShowing = document.getElementById('todoListButtonShowing');
const usernameEnterForm = document.getElementById('usernameEnterForm');
const linking = document.getElementById('linking');

const provider = new firebase.auth.GoogleAuthProvider();
var twitterprovider = new firebase.auth.TwitterAuthProvider();
var githubprovider = new firebase.auth.GithubAuthProvider();
var db = firebase.firestore();


function twitterSignin() {
    firebase.auth().signInWithPopup(twitterprovider)
    
    .then(function(result) {
        var token = result.credential.accessToken;
        var user = result.user;
            
        console.log(token)
        console.log(user)
        }).catch(function(error) {
        console.log(error.code)
        console.log(error.message)
        });
}

function githubSignin() {
    firebase.auth().signInWithPopup(githubprovider)

    .then(function(result) {
        var token = result.credential.accessToken;
        var user = result.user;
            
        console.log(token)
        console.log(user)
    }).catch(function(error) {
        var errorCode = error.code;
        var errorMessage = error.message;
            
        console.log(error.code)
        console.log(error.message)

        errorDiv.innerHTML = `<p>${error.message}</p>`
    });
}

signInBtn.onclick = () => auth.signInWithPopup(provider);

signOutBtn.onclick = () => auth.signOut();

socialButton.onclick = () => {
  socialDiv.hidden = false;
}

auth.onAuthStateChanged(user => {
    if (user) {
        whenSignedIn.hidden = false;
        whenSignedOut.hidden = true;
        // userDetails.innerHTML = `<h3>Hello ${user.displayName}!</h3> <p>User ID: ${user.uid}</p>`;
        console.log(user)

        // var pfp = firebase.auth().currentUser.photoURL
        // userDetails.innerHTML = `<h3>Hello ${user.displayName}!</h3><img src='${pfp}'> <p>User ID: ${user.uid}</p>`;
        const { serverTimestamp } = firebase.firestore.FieldValue;
        const userName = user.displayName

            db.collection("userData").get().then(function(querySnapshot) {
            querySnapshot.forEach(function(doc) {
            // doc.data() is never undefined for query doc snapshots
            console.log(doc.id, " => ", doc.data().userId);
            userTag = firebase.auth().currentUser.uid.substring(0, 4);
            userNameAndTagUser = `${firebase.auth().currentUser.displayName}#${userTag}`
             if (firebase.auth().currentUser.uid == doc.data().userId) {
                 console.log('lol')
             } else {
                db.collection("userData").doc(userName).set({
                    userId: user.uid,
                    userName: user.displayName,
                    userPhoto: user.photoURL,
                    userEmail: user.email,
                    userPhone: user.phoneNumber,
                    userNameAndTag: userNameAndTagUser,
                    createdAt: serverTimestamp()
                })
             }
            });
        });

        db.collection("userData").get().then(function(querySnapshot) {
        querySnapshot.forEach(function(doc) {
          console.log(doc.id, " => ", doc.data().userNameAndTag);
          socialDiv.innerHTML = `<p>Your username is ${firebase.auth().currentUser.displayName}#${userTag}</p>        
          <form id="usernameEnterForm">
          <input type="text" placeholder="Enter username" id="usernameInput">
          <input type="submit" id="usernameSubmit">
          </form>`

          const usernameSubmit = document.getElementById('usernameSubmit');
          const usernameInput = document.getElementById('usernameInput');
          var listOfUserNames = [doc.data().userNameAndTag]
          console.log(listOfUserNames)
          usernameSubmit.onclick = (e) => {
            e.preventDefault();
            window.usernameInputValue = usernameInput.value;
            console.log(window.usernameInputValue);
            if (listOfUserNames.indexOf(window.usernameInputValue) > -1) {
              e.preventDefault();
              socialDiv.innerHTML = `<p>Your username is ${firebase.auth().currentUser.displayName}#${userTag}</p>
            <h3>Friend request sent to ${window.usernameInputValue}</h3>`
              db.collection("userData").doc(userName).set({
                    userId: user.uid,
                    userName: user.displayName,
                    userPhoto: user.photoURL,
                    userEmail: user.email,
                    userPhone: user.phoneNumber,
                    userNameAndTag: userNameAndTagUser,
                    sentFriendRequests: window.usernameInputValue,
                    createdAt: serverTimestamp()
                  
            })
            }else{
              e.preventDefault();
              socialDiv.innerHTML = `<p>Your username is ${firebase.auth().currentUser.displayName}#${userTag}</p>        
              <form id="usernameEnterForm">
              <input type="text" placeholder="Enter username" id="usernameInput">
              <input type="submit" id="usernameSubmit">
              </form>
              <h3 id="usernameNotFound">Person by that username not found</h3>`
              return
            }

          }
          var recievedFriendRequests = doc.data().sentFriendRequests;
            if (recievedFriendRequests == db.collection("userData").doc(firebase.auth().currentUser.displayName).userNameAndTag) {
              console.log('You have recieved a friend request!')
              socialDiv.innerHTML = `<p>Your username is ${firebase.auth().currentUser.displayName}#${userTag}</p>        
                <form id="usernameEnterForm">
                <input type="text" placeholder="Enter username" id="usernameInput">
                <input type="submit" id="usernameSubmit">
                </form>
                <h3 id="youGotFriendRequest">You have recieved a friend request from ${doc.id}</h3>`
                return
            } else {
              return
            }
        });
    });
        
    } else {
        whenSignedIn.hidden = true;
        whenSignedOut.hidden = false;
    }
});



</script>
</html>
